<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prototype Génération de Mélodie</title>
  <link rel="stylesheet" href="styles.css?v=39">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
</head>
<body>
  <p class="site-version">Version du site&nbsp;: v39</p>
  <header class="hero">
    <div>
      <p class="eyebrow">Prototype</p>
      <h1>Générateur de mélodie</h1>
      <p class="lead">
        Configurez les paramètres, générez une mélodie contrainte par les règles A/B/C/E, puis écoutez la séquence avec l’instrument sélectionné.
      </p>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>Paramètres</h2>
      <div class="form-grid">
        <label class="field" for="primary-tones">
          <span>Primary tones (A)</span>
          <textarea id="primary-tones" rows="2" placeholder="Ex: c#, e, g">e, g, b</textarea>
        </label>

        <label class="field" for="secondary-tones">
          <span>Secondary tones (B)</span>
          <textarea id="secondary-tones" rows="2" placeholder="Ex: d, f#, a">f#, a, c, d</textarea>
        </label>

        <label class="field" for="forbidden-tones">
          <span>Forbidden tones (C)</span>
          <textarea id="forbidden-tones" rows="2" placeholder="Ex: db, gb, bb">g#, c#</textarea>
        </label>

        <label class="field" for="ambitus-min">
          <span>Ambitus min (MIDI)</span>
          <input id="ambitus-min" type="number" min="0" max="127" step="1" value="50">
        </label>

        <label class="field" for="ambitus-max">
          <span>Ambitus max (MIDI)</span>
          <input id="ambitus-max" type="number" min="0" max="127" step="1" value="72">
        </label>

        <label class="field" for="instrument-select">
          <span>Instrument</span>
          <select id="instrument-select"></select>
        </label>
      </div>

      <h3>Probabilités rythmiques</h3>
      <label class="slider-row bpm-row" for="bpm-slider">
        <span class="slider-label">BPM</span>
        <div class="slider-input-wrap">
          <input id="bpm-slider" type="range" min="30" max="140" step="1" value="92">
          <span class="slider-value" id="bpm-value">92</span>
        </div>
      </label>
      <label class="slider-row" for="repetition-penalty-slider">
        <span class="slider-label">Pénalité notes répétées</span>
        <div class="slider-input-wrap">
          <input id="repetition-penalty-slider" type="range" min="0" max="1" step="0.01" value="0.25">
          <span class="slider-value" id="repetition-penalty-value">0.25</span>
        </div>
      </label>
      <div class="rhythm-grid" id="jump-sliders"></div>

      <h3>Triolets</h3>
      <div class="slider-group" id="triplet-sliders"></div>

      <h3>Génération note suivante après triolet</h3>
      <div class="slider-group" id="after-triplet-sliders"></div>

      <div class="preset-row">
        <input id="preset-name" type="text" placeholder="Nom du preset rythmique">
        <button id="save-preset-btn" type="button">Sauvegarder preset</button>
        <select id="preset-select"></select>
        <button id="load-preset-btn" type="button">Charger</button>
        <button id="delete-preset-btn" type="button">Effacer</button>
      </div>

      <div class="preset-transfer-row">
        <button id="export-preset-values-btn" type="button">Exporter probas (.json)</button>
        <button id="import-preset-values-btn" type="button">Importer probas</button>
        <input id="import-preset-values-file" type="file" accept="application/json" hidden>
      </div>

      <h3>Règles d’ornements (par note)</h3>
      <div class="ornament-rules" id="ornament-rules">
        <label><input id="rule-long-note-e" type="checkbox"> Long → note de catégorie E, si non répétée</label>
        <label><input id="rule-long-note-b" type="checkbox"> Long → note de catégorie B, si non répétée</label>
        <label><input id="rule-long-last-preset-melodique" type="checkbox"> Long → toutes les notes si dernier preset chargé = «&nbsp;Mélodique&nbsp;»</label>
        <label><input id="rule-no-long-last-preset-syncope" type="checkbox"> Long → désactivé si dernier preset chargé = «&nbsp;Syncopé&nbsp;»</label>
        <label><input id="rule-fall-last-note" type="checkbox"> Fall → dernière note (démarre à mi-note)</label>
        <label><input id="rule-fall-interval-3" type="checkbox"> Fall → note de catégorie A, pas « long », et distante d’au moins 3 double-croches avec la suivante</label>
        <label><input id="rule-bend-first-if-3" type="checkbox"> Bend → première note si sa longueur est d’au moins 3 double-croches</label>
        <label><input id="rule-vibrato-longest" type="checkbox"> Vibrato (± 1/2 ton) → note la plus longue de la série (uniquement si « long » et sans bend)</label>
        <label><input id="rule-portamento-before-largest-interval" type="checkbox"> Portamento → note avant le plus grand intervalle (si elle tient jusqu’à la suivante)</label>
      </div>

      <h3>Monosynth (mélodie uniquement)</h3>
      <div class="slider-group" id="monosynth-sliders">
        <label class="slider-row" for="mono-envelope-attack">
          <span class="slider-label">Envelope attack (s)</span>
          <div class="slider-input-wrap"><input id="mono-envelope-attack" type="range" min="0.001" max="0.1" step="0.001" value="0.005"><span class="slider-value mono-value" id="mono-envelope-attack-value">0.005</span></div>
        </label>
        <label class="slider-row" for="mono-envelope-decay">
          <span class="slider-label">Envelope decay (s)</span>
          <div class="slider-input-wrap"><input id="mono-envelope-decay" type="range" min="0.01" max="0.5" step="0.01" value="0.04"><span class="slider-value mono-value" id="mono-envelope-decay-value">0.04</span></div>
        </label>
        <label class="slider-row" for="mono-envelope-sustain">
          <span class="slider-label">Envelope sustain</span>
          <div class="slider-input-wrap"><input id="mono-envelope-sustain" type="range" min="0" max="1" step="0.01" value="0.85"><span class="slider-value mono-value" id="mono-envelope-sustain-value">0.85</span></div>
        </label>
        <label class="slider-row" for="mono-envelope-release">
          <span class="slider-label">Envelope release (s)</span>
          <div class="slider-input-wrap"><input id="mono-envelope-release" type="range" min="0.01" max="1" step="0.01" value="0.08"><span class="slider-value mono-value" id="mono-envelope-release-value">0.08</span></div>
        </label>
        <label class="slider-row" for="mono-filter-frequency">
          <span class="slider-label">Filter frequency (Hz)</span>
          <div class="slider-input-wrap"><input id="mono-filter-frequency" type="range" min="60" max="20000" step="10" value="20000"><span class="slider-value mono-value" id="mono-filter-frequency-value">20000</span></div>
        </label>
        <label class="slider-row" for="mono-filter-q">
          <span class="slider-label">Filter Q</span>
          <div class="slider-input-wrap"><input id="mono-filter-q" type="range" min="0" max="20" step="0.1" value="0"><span class="slider-value mono-value" id="mono-filter-q-value">0</span></div>
        </label>
        <label class="slider-row" for="mono-filter-env-base-frequency">
          <span class="slider-label">Filter env base freq (Hz)</span>
          <div class="slider-input-wrap"><input id="mono-filter-env-base-frequency" type="range" min="60" max="20000" step="10" value="20000"><span class="slider-value mono-value" id="mono-filter-env-base-frequency-value">20000</span></div>
        </label>
        <label class="slider-row" for="mono-filter-env-octaves">
          <span class="slider-label">Filter env octaves</span>
          <div class="slider-input-wrap"><input id="mono-filter-env-octaves" type="range" min="0" max="6" step="0.1" value="0"><span class="slider-value mono-value" id="mono-filter-env-octaves-value">0</span></div>
        </label>
      </div>

      <div class="controls">
        <button class="primary" id="generate-btn" type="button">Générer</button>
        <button id="replay-btn" type="button" disabled>Replay</button>
      </div>

      <p id="status" class="status">Prêt.</p>
    </section>

    <section class="panel">
      <h2>Résultat</h2>
      <p><strong>Instrument:</strong> <span id="result-instrument">—</span></p>
      <p><strong>Pattern (4 temps):</strong> <span id="result-pattern">—</span></p>
      <p><strong>Série:</strong> <span id="result-sequence">—</span></p>
      <p><strong>Conditions vibrato:</strong> <span id="result-vibrato-conditions">—</span></p>
    </section>
  </main>

  <footer>
    <p>Version prototype v39: vibrato ± 1/2 ton et réglages monosynth exposés en interface.</p>
  </footer>

  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js?v=39"></script>
  <script type="module" src="main.js?v=39"></script>
</body>
</html>
